# Архитектура системы ETH Spread Monitor

## Общая схема

Система состоит из следующих основных компонентов:

```
┌─────────────────────────────────────────────────────────────┐
│                      main.py                                 │
│              (Точка входа, управление)                       │
└──────────────────────┬──────────────────────────────────────┘
                       │
        ┌──────────────┴──────────────┐
        │                             │
┌───────▼────────┐          ┌─────────▼─────────┐
│  SpreadMonitor │          │   WebServer       │
│  (Мониторинг)  │◄─────────┤  (Веб-интерфейс)  │
└───────┬────────┘          └───────────────────┘
        │
        ├──────────────────┬──────────────────┐
        │                  │                  │
┌───────▼────────┐ ┌───────▼────────┐ ┌───────▼──────────┐
│ ByBitClient    │ │SpreadCalculator│ │TelegramNotifier  │
│ (API клиент)   │ │ (Расчеты)      │ │ (Уведомления)    │
└────────────────┘ └────────────────┘ └──────────────────┘
```

## Компоненты системы

### 1. main.py
**Назначение**: Точка входа приложения, инициализация всех компонентов и управление жизненным циклом.

**Основные функции**:
- Инициализация всех компонентов
- Запуск мониторинга в отдельной задаче
- Запуск веб-сервера в отдельном потоке
- Обработка сигналов остановки

### 2. SpreadMonitor (src/monitor.py)
**Назначение**: Основной модуль мониторинга, координирует работу всех компонентов.

**Основные функции**:
- Получение данных с биржи через ByBitClient
- Расчет спредов через SpreadCalculator
- Сравнение спредов с Funding Rate
- Отправка сигналов через TelegramNotifier
- Обновление данных для веб-интерфейса через callback

**Алгоритм работы**:
1. Периодически (каждые N секунд, настраивается через веб-интерфейс) получает данные:
   - Цену бессрочного фьючерса (символ настраивается через веб-интерфейс)
   - Цены всех срочных фьючерсов (список настраивается через веб-интерфейс)
   - Текущий Funding Rate
   - История Funding Rate для расчета среднего (период настраивается через веб-интерфейс)
2. Рассчитывает спреды для каждого срочного фьючерса
3. Сравнивает спред с Funding Rate по условию:
   `Спред % < (Funding Rate % - Порог %)` (порог настраивается через веб-интерфейс)
4. При выполнении условия отправляет сигнал в Telegram
5. Обновляет данные для веб-интерфейса

**Особенности**:
- Динамическое чтение конфигурации при каждом обновлении данных
- Поддержка изменения параметров без перезапуска
- Callback для получения актуальной конфигурации из `config.py`

### 3. ByBitClient (src/bybit_client.py)
**Назначение**: Клиент для работы с ByBit API.

**Основные методы**:
- `get_perpetual_ticker()` - получить цену бессрочного фьючерса
- `get_futures_ticker()` - получить цену срочного фьючерса
- `get_current_funding_rate()` - получить текущий Funding Rate
- `get_funding_rate_history()` - получить историю Funding Rate
- `calculate_average_funding_rate()` - рассчитать средний Funding Rate

**Особенности**:
- Использует библиотеку `pybit` для работы с API
- Поддерживает работу с тестовой сетью (testnet)
- Обрабатывает ошибки и возвращает None при сбоях

### 4. SpreadCalculator (src/spread_calculator.py)
**Назначение**: Расчет спредов и проверка условий для сигналов.

**Основные классы и методы**:
- `SpreadData` - dataclass для хранения данных о спреде
- `FundingRateData` - dataclass для хранения данных о Funding Rate
- `calculate_spread()` - расчет спреда для одного фьючерса
- `calculate_spreads()` - расчет спредов для всех фьючерсов
- `should_alert()` - проверка условия для отправки сигнала

**Формулы**:
- Спред = Цена срочного фьючерса - Цена бессрочного фьючерса
- Спред % = (Спред / Цена бессрочного фьючерса) × 100
- Условие сигнала: `Спред % < (Funding Rate % - Порог %)`

### 5. TelegramNotifier (src/telegram_notifier.py)
**Назначение**: Отправка уведомлений в Telegram.

**Основные методы**:
- `send_message()` - отправить текстовое сообщение
- `send_alert()` - отправить сигнал о спреде (форматированное сообщение)

**Особенности**:
- Использует библиотеку `python-telegram-bot`
- Поддерживает HTML форматирование
- Обрабатывает ошибки отправки

### 6. WebServer (src/web_server.py)
**Назначение**: Веб-сервер для отображения данных в реальном времени и управления конфигурацией.

**Технологии**:
- FastAPI - веб-фреймворк
- WebSocket - для real-time обновлений
- HTML/CSS/JavaScript - frontend

**Endpoints**:
- `GET /` - главная страница с веб-интерфейсом
- `GET /api/data` - REST API для получения текущих данных (JSON)
- `GET /api/config` - REST API для получения текущей конфигурации (JSON)
- `PUT /api/config` - REST API для обновления конфигурации
- `WS /ws` - WebSocket для получения обновлений в реальном времени

**Особенности**:
- WebSocket соединения для всех подключенных клиентов
- Автоматическая рассылка обновлений всем клиентам
- Красивый адаптивный интерфейс с двумя вкладками:
  - **Мониторинг** - отображение данных в реальном времени
  - **Настройки** - форма для изменения параметров конфигурации
- Динамическое обновление конфигурации без перезапуска приложения
- Сохранение изменений конфигурации в файл `config.json`

### 7. config.py
**Назначение**: Конфигурация приложения с поддержкой динамического изменения.

**Источники конфигурации**:
- **Статические параметры** (только через .env):
  - Переменные окружения (приоритет)
  - Файл `.env`
  - Значения по умолчанию
- **Динамические параметры** (можно изменять через веб-интерфейс):
  - Файл `config.json` (приоритет при загрузке)
  - Переменные окружения из `.env` (fallback)
  - Значения по умолчанию

**Параметры**:
- **Статические** (не изменяются через веб-интерфейс):
  - Настройки ByBit API (API ключ, секрет)
  - Настройки Telegram бота (токен, chat ID)
  - Настройки веб-сервера (хост, порт)
- **Динамические** (изменяются через веб-интерфейс):
  - Порог спреда для сигнала
  - Количество дней истории Funding Rate
  - Интервал мониторинга
  - Символ бессрочного фьючерса
  - Список символов срочных фьючерсов

**Функции**:
- `load_config_from_file()` - загрузить конфигурацию из `config.json`
- `save_config_to_file()` - сохранить конфигурацию в `config.json`
- `get_updatable_config()` - получить только изменяемые параметры
- `update_config()` - обновить конфигурацию с валидацией и сохранением

## Поток данных

```
┌──────────────┐
│  ByBit API   │
└──────┬───────┘
       │
       ▼
┌──────────────┐     ┌──────────────┐
│ ByBitClient  │────►│SpreadMonitor │
└──────────────┘     └──────┬───────┘
                            │
        ┌───────────────────┼───────────────────┐
        │                   │                   │
        ▼                   ▼                   ▼
┌──────────────┐   ┌──────────────┐   ┌──────────────┐
│SpreadCalc    │   │TelegramNotif │   │  WebServer   │
│(расчеты)     │   │(сигналы)     │   │(веб-страница)│
└──────────────┘   └──────────────┘   └──────────────┘
```

## Асинхронность

Система построена на асинхронном подходе:

1. **Мониторинг** - работает в бесконечном цикле с заданным интервалом
2. **Веб-сервер** - работает в отдельном потоке, не блокирует мониторинг
3. **API запросы** - выполняются параллельно через `run_in_executor`
4. **WebSocket** - обрабатывает множество соединений одновременно

## Обработка ошибок

Все компоненты имеют обработку ошибок:

- **ByBitClient**: Возвращает None при ошибках API
- **TelegramNotifier**: Логирует ошибки, не прерывает работу
- **SpreadMonitor**: Продолжает работу при ошибках получения данных
- **WebServer**: Изолирует ошибки клиентов WebSocket

## Масштабируемость

Система может быть легко расширена:

1. **Добавление новых бирж** - создать новый клиент по аналогии с ByBitClient
2. **Добавление каналов уведомлений** - создать новый модуль уведомлений
3. **Изменение логики мониторинга** - редактировать SpreadMonitor
4. **Добавление новых метрик** - расширить SpreadCalculator

## Безопасность

- API ключи хранятся в `.env` файле (не коммитится в git)
- Токены Telegram хранятся в `.env` файле
- Веб-сервер слушает только на указанном хосте/порту
- Нет авторизации для веб-интерфейса (можно добавить при необходимости)

## Производительность

- Параллельные запросы к API для всех фьючерсов
- Минимальная задержка между обновлениями (настраивается)
- Эффективная рассылка через WebSocket
- Локальное кеширование текущих данных

## Логирование

Все компоненты используют стандартный модуль logging Python:
- Уровни: INFO, WARNING, ERROR
- Логи сохраняются в файл `eth_spread_monitor.log`
- Логи также выводятся в консоль


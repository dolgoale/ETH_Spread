# Конфигурация Nginx для авторизации через auth_service
# Добавьте эти блоки в конфигурацию вашего домена

# Блок для проверки авторизации
location = /auth/check {
    internal;
    proxy_pass http://localhost:9000/auth/check;
    proxy_pass_request_body off;
    proxy_set_header Content-Length "";
    proxy_set_header X-Original-URI $request_uri;
    proxy_set_header X-Original-Method $request_method;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Проксирование запросов к auth_service
location /auth/ {
    proxy_pass http://localhost:9000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Передача cookies
    proxy_cookie_path / /;
}

# Проксирование API для администратора
location /api/admin/ {
    proxy_pass http://localhost:9000;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Передача cookies
    proxy_cookie_path / /;
}

# Защита основного контента через авторизацию
location / {
    # Проверка авторизации
    auth_request /auth/check;
    
    # Если не авторизован, перенаправляем на логин
    error_page 401 = @auth_required;
    
    # Ваш обычный proxy_pass или root
    # proxy_pass http://localhost:8000;  # для BBSpreads
    # или
    # try_files $uri $uri/ =404;  # для статического сайта
}

# Обработка неавторизованных запросов
location @auth_required {
    return 302 https://$host/auth/login?redirect=$request_uri;
}

